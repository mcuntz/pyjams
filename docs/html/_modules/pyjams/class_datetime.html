
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyjams.class_datetime &#8212; pyjams 1.27.dev1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyjams.class_datetime</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Conversion of datetime formats</span>

<span class="sd">The module enhances cftime by non-CF date formats.</span>

<span class="sd">This module was written by Matthias Cuntz while at Institut National de</span>
<span class="sd">Recherche pour l&#39;Agriculture, l&#39;Alimentation et l&#39;Environnement (INRAE), Nancy,</span>
<span class="sd">France.</span>

<span class="sd">:copyright: Copyright 2022- Matthias Cuntz, see AUTHORS.rst for details.</span>
<span class="sd">:license: MIT License, see LICENSE for details.</span>

<span class="sd">.. moduleauthor:: Matthias Cuntz</span>

<span class="sd">The following functions are provided:</span>

<span class="sd">.. autosummary::</span>
<span class="sd">   date2dec</span>
<span class="sd">   date2num</span>
<span class="sd">   dec2date</span>
<span class="sd">   num2date</span>
<span class="sd">   datetime</span>

<span class="sd">History</span>
<span class="sd">    * Written date2dec and dec2date Jun 2010, Arndt Piayda</span>
<span class="sd">    * Input can be scalar or array_like, Feb 2012, Matthias Cuntz</span>
<span class="sd">    * fulldate=True default in dec2date, Feb 2012, Matthias Cuntz</span>
<span class="sd">    * Added calendars decimal and decimal360, Feb 2012, Matthias Cuntz</span>
<span class="sd">    * Rename units to refdate and add units as in netcdftime in dec2date,</span>
<span class="sd">      Jun 2012, Matthias Cuntz</span>
<span class="sd">    * Add units=&#39;day as %Y%m%d.%f&#39; in dec2date, Jun 2012, Matthias Cuntz</span>
<span class="sd">    * Change units of proleptic_gregorian from &#39;days since 0001-01-01 00:00:00&#39;</span>
<span class="sd">      to &#39;days since 0001-01-00 00:00:00&#39; in date2dec, Dec 2012, Matthias Cuntz</span>
<span class="sd">    * Bug in Excel and leap years, Feb 2013</span>
<span class="sd">    * Ported to Python 3, Feb 2013</span>
<span class="sd">    * Bug in &#39;eng&#39; output of dec2date, May 2013, Arndt Piayda</span>
<span class="sd">    * Times with keywords ascii and eng default to 00:00:00 in date2dec,</span>
<span class="sd">      Jul 2013, Matthias Cuntz</span>
<span class="sd">    * Corrected that Excel year starts as 1 not at 0, Oct 2013, Matthias Cuntz</span>
<span class="sd">    * But in units keyword and Julian calendar, day was subtracted even if</span>
<span class="sd">      units were given, Oct 2013, Matthias Cuntz</span>
<span class="sd">    * Removed remnant of time treatment before time check in eng keyword in</span>
<span class="sd">      date2dec, Nov 2013, Matthias Cuntz</span>
<span class="sd">    * Adapted date2dec to new netCDF4/netcdftime (&gt;=v1.0) and Python datetime</span>
<span class="sd">      (&gt;v2.7.9), Jun 2015, Matthias Cuntz</span>
<span class="sd">    * Add units==&#39;month as %Y%m.%f&#39; and units==&#39;year as %Y.%f&#39; in dec2date,</span>
<span class="sd">      May 2016, Matthias Cuntz</span>
<span class="sd">    * Now possible to pass array_like to date2num instead of single</span>
<span class="sd">      netCDF4.datetime objects in date2dec, Oct 2016, Matthias Cuntz</span>
<span class="sd">    * Provide netcdftime even with netCDF4 &gt; v1.0.0, Oct 2016, Matthias Cuntz</span>
<span class="sd">    * mo is always integer in date2dec, Oct 2016, Matthias Cuntz</span>
<span class="sd">    * leap is always integer in dec2date, Oct 2016, Matthias Cuntz</span>
<span class="sd">    * Corrected 00, 01, etc. in date2dec, which are not accepted as integer</span>
<span class="sd">      constants by Python 3, Nov 2016, Matthias Cuntz</span>
<span class="sd">    * numpydoc docstring format, May 2020, Matthias Cuntz</span>
<span class="sd">    * Renamed eng keword to en, Jul 2020, Matthias Cuntz</span>
<span class="sd">    * Use proleptic_gregorian calendar for Excel dates,</span>
<span class="sd">      Jul 2020, Matthias Cuntz</span>
<span class="sd">    * Change all np.int, np.float, etc. to Python equivalents,</span>
<span class="sd">      May 2021, Matthias Cuntz</span>
<span class="sd">    * flake8 compatible, May 2021, Matthias Cuntz</span>
<span class="sd">    * Written class_datetime, Jun 2022, Matthias Cuntz</span>
<span class="sd">      Complete rewrite from scratch following closely cftime but for</span>
<span class="sd">      non-CF-conform calendars such as decimal, Excel, and the cdo</span>
<span class="sd">      absolute time formats (e.g. units=&#39;day as %Y%m%d.%f&#39;).</span>
<span class="sd">      Provides its own datetime class.</span>
<span class="sd">      Use cftime notation now, i.e. date2num and num2date but provide</span>
<span class="sd">      date2dec and dec2date wrappers for backward compatibility (almost).</span>
<span class="sd">      Provide microsecond resolution with all supported calendars no matter</span>
<span class="sd">      of the units, which means that date2num returns np.longdouble values.</span>
<span class="sd">      date2num works together with date2date and can have formatted date</span>
<span class="sd">      strings as input.</span>
<span class="sd">    * calendar keyword takes precedence on calendar attribute of</span>
<span class="sd">      datetime objects in date2num, Jul 2022, Matthias Cuntz</span>
<span class="sd">    * return_arrays keyword in date2num, Jul 2022, Matthias Cuntz</span>
<span class="sd">    * round_microseconds method for datetime, Jul 2022, Matthias Cuntz</span>

<span class="sd">ToDo</span>
<span class="sd">    * Check why datetime + timedelta but not timedelta + datetime</span>
<span class="sd">    * add date2index</span>
<span class="sd">    * add time2index</span>
<span class="sd">    * implement fromordinal</span>
<span class="sd">    * implement change_calendar</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">ptime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">datetime_python</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cftime</span> <span class="k">as</span> <span class="nn">cf</span>
<span class="kn">from</span> <span class="nn">.helper</span> <span class="kn">import</span> <span class="n">input2array</span><span class="p">,</span> <span class="n">array2input</span>
<span class="kn">from</span> <span class="nn">.date2date</span> <span class="kn">import</span> <span class="n">date2date</span>
<span class="c1"># from pyjams.helper import input2array, array2input</span>
<span class="c1"># from pyjams.date2date import date2date</span>


<span class="c1"># from ._cftime import num2date, date2num, date2index, time2index, num2pydate</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date2dec&#39;</span><span class="p">,</span> <span class="s1">&#39;date2num&#39;</span><span class="p">,</span> <span class="s1">&#39;date2dec&#39;</span><span class="p">,</span> <span class="s1">&#39;num2date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]</span>


<span class="c1"># supported calendars. Includes synonyms (&#39;excel&#39;==&#39;excel1900&#39;)</span>
<span class="n">_excelcalendars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;excel&#39;</span><span class="p">,</span> <span class="s1">&#39;excel1900&#39;</span><span class="p">,</span> <span class="s1">&#39;excel1904&#39;</span><span class="p">]</span>
<span class="n">_decimalcalendars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;decimal&#39;</span><span class="p">,</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">,</span> <span class="s1">&#39;decimal365&#39;</span><span class="p">,</span> <span class="s1">&#39;decimal366&#39;</span><span class="p">]</span>
<span class="n">_noncfcalendars</span> <span class="o">=</span> <span class="n">_excelcalendars</span> <span class="o">+</span> <span class="n">_decimalcalendars</span>
<span class="n">_cfcalendars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="s1">&#39;proleptic_gregorian&#39;</span><span class="p">,</span>
                <span class="s1">&#39;noleap&#39;</span><span class="p">,</span> <span class="s1">&#39;julian&#39;</span><span class="p">,</span> <span class="s1">&#39;all_leap&#39;</span><span class="p">,</span> <span class="s1">&#39;365_day&#39;</span><span class="p">,</span> <span class="s1">&#39;366_day&#39;</span><span class="p">,</span>
                <span class="s1">&#39;360_day&#39;</span><span class="p">]</span>
<span class="n">_idealized_cfcalendars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;all_leap&#39;</span><span class="p">,</span> <span class="s1">&#39;noleap&#39;</span><span class="p">,</span> <span class="s1">&#39;366_day&#39;</span><span class="p">,</span> <span class="s1">&#39;365_day&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;360_day&#39;</span><span class="p">]</span>

<span class="c1"># number of days in year</span>
<span class="n">_dayspermonth</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">]</span>
<span class="n">_dayspermonth_leap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">]</span>
<span class="n">_dayspermonth_360</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="n">_cumdayspermonth</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span>
                         <span class="mi">212</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">334</span><span class="p">,</span> <span class="mi">365</span><span class="p">]</span>
<span class="n">_cumdayspermonth_leap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span>
                         <span class="mi">213</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">274</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">335</span><span class="p">,</span> <span class="mi">366</span><span class="p">]</span>
<span class="n">_cumdayspermonth_360</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span>
                         <span class="mi">210</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">330</span><span class="p">,</span> <span class="mi">360</span><span class="p">]</span>

<span class="c1">#</span>
<span class="c1"># Exact copies of private cftime routines</span>
<span class="c1"># (changed Python time to ptime)</span>
<span class="c1">#</span>

<span class="n">_illegal_s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((^|[^%])(</span><span class="si">%%</span><span class="s2">)*</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_findall</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">substr</span><span class="p">):</span>
    <span class="c1"># Also finds overlaps</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">substr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">sites</span>


<span class="k">def</span> <span class="nf">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a datetime instance into a tuple of integers. Elements go</span>
<span class="sd">    in the order of decreasing significance, making it easy to compare</span>
<span class="sd">    datetime instances. Parts of the state that don&#39;t affect ordering</span>
<span class="sd">    are omitted. Compare to timetuple().</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
            <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>


<span class="c1"># factory function without optional kwargs that can be used in</span>
<span class="c1"># datetime.__reduce_</span>
<span class="k">def</span> <span class="nf">_create_datetime</span><span class="p">(</span><span class="n">date_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">date_type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># Adapted cftime routines</span>
<span class="c1">#</span>

<span class="c1"># Every 28 years the calendar repeats, except through century leap</span>
<span class="c1"># years where it&#39;s 6 years. But only if you&#39;re using the Gregorian</span>
<span class="c1"># calendar. ;-)</span>
<span class="c1"># Make also 4-digit negative years</span>
<span class="c1"># Allow .%f for microseconds</span>
<span class="k">def</span> <span class="nf">_strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_illegal_s</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;This strftime implementation does not handle </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fmt</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;If </span><span class="si">%f</span><span class="s1"> is used for microseconds it must be the&#39;</span>
                            <span class="s1">&#39; at the end as .</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ihavems</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fmt1</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ihavems</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fmt1</span> <span class="o">=</span> <span class="n">fmt</span>

    <span class="c1"># don&#39;t use strftime method at all.</span>
    <span class="c1"># if dt.year &gt; 1900:</span>
    <span class="c1">#    return dt.strftime(fmt)</span>

    <span class="n">year</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="c1"># For every non-leap year century, advance by</span>
    <span class="c1"># 6 years to get into the 28-year repeat cycle</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mi">2000</span> <span class="o">-</span> <span class="n">year</span>
    <span class="n">off</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="n">delta</span> <span class="o">//</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">//</span> <span class="mi">400</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="n">off</span>

    <span class="c1"># Move to around the year 2000</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="p">((</span><span class="mi">2000</span> <span class="o">-</span> <span class="n">year</span><span class="p">)</span> <span class="o">//</span> <span class="mi">28</span><span class="p">)</span> <span class="o">*</span> <span class="mi">28</span>
    <span class="c1"># timetuple does not include microseconds</span>
    <span class="n">timetuple</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span>
    <span class="c1"># time.strftime does hence not treat microseconds. i.e. format code %f</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">ptime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt1</span><span class="p">,</span> <span class="p">(</span><span class="n">year</span><span class="p">,)</span> <span class="o">+</span> <span class="n">timetuple</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">sites1</span> <span class="o">=</span> <span class="n">_findall</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>

    <span class="n">s2</span> <span class="o">=</span> <span class="n">ptime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt1</span><span class="p">,</span> <span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">28</span><span class="p">,)</span> <span class="o">+</span> <span class="n">timetuple</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">sites2</span> <span class="o">=</span> <span class="n">_findall</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">28</span><span class="p">))</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites2</span><span class="p">:</span>
            <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s1</span>
    <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">syear</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%05d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">syear</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,)</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">site</span><span class="p">]</span> <span class="o">+</span> <span class="n">syear</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">site</span> <span class="o">+</span> <span class="mi">4</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">ihavems</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;.</span><span class="si">{:06d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">_datesplit</span><span class="p">(</span><span class="n">timestr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a unit string for time into its three components:</span>
<span class="sd">    unit, string &#39;since&#39; or &#39;as&#39;, and the remainder</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">sincestring</span><span class="p">,</span> <span class="n">remainder</span><span class="p">)</span> <span class="o">=</span> <span class="n">timestr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Incorrectly formatted date-time unit_string:&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">timestr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sincestring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;since&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;since&#39; or &#39;as&#39; in unit_string:&quot;</span>
                         <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">timestr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">sincestring</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">remainder</span>


<span class="k">def</span> <span class="nf">_year_zero_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set calendar specific defaults for having year 0 or not</span>

<span class="sd">    Excel calendars *excel*, *excel1900*, *excel1904* start only 1900</span>
<span class="sd">    or above, i.e. no year 0.</span>

<span class="sd">    Decimal calendars *decimal*, *decimal360*, *decimal365*, *decimal366*</span>
<span class="sd">    have year 0 by default but might also omit it.</span>

<span class="sd">    Real-world calendars *standard*, *gregorian*, *julian* have no year 0.</span>

<span class="sd">    *proleptic_gregorian* (ISO 8601) and the idealized calendars</span>
<span class="sd">    *noleap*/*365_day*, *360_day*, *366_day*/*all_leap* have by default</span>
<span class="sd">    a year 0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the supported calendar names in *_noncfcalendars*</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">       True if calendar includes year 0 by default</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; print(_year_zero_defaults(&#39;Excel&#39;))</span>
<span class="sd">    False</span>
<span class="sd">    &gt;&gt;&gt; print(_year_zero_defaults(&#39;decimal&#39;))</span>
<span class="sd">    True</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="s1">&#39;julian&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;proleptic_gregorian&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># ISO 8601 year zero=1 BC</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_idealized_cfcalendars</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_decimalcalendars</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_leap</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines if a specific year in a given calendar is a leap year</span>

<span class="sd">    *has_year_zero* controls whether astronomical year numbering</span>
<span class="sd">    is used and the year zero exists. If not specified,</span>
<span class="sd">    calendar-specific default is assumed.</span>

<span class="sd">    Excel calendars *excel*, *excel1900*, *excel1904* start only in 1900</span>
<span class="sd">    or above, i.e. no year 0 allowed.</span>

<span class="sd">    Decimal calendars *decimal*, *decimal360*, *decimal365*, *decimal366*</span>
<span class="sd">    have year 0 by default but might omit it by setting *has_year_zero=False*.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year : int or array_like of int</span>
<span class="sd">        Year(s) to check if leap year</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the supported calendar names in *_noncfcalendars*</span>
<span class="sd">    has_year_zero : bool, optional</span>
<span class="sd">        Astronomical year numbering is used, i.e. year zero exists, if True</span>
<span class="sd">        and possible for the given *calendar*. If *None* (default),</span>
<span class="sd">        calendar-specific defaults are assumed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool or array of bool</span>
<span class="sd">       True if year is a leap year</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If there is no year 0 in a calendar, years -1, -5, -9, etc. are leap years.</span>
<span class="sd">    Year 0 is a leap year if it exists.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; years = [1900, 1904]</span>
<span class="sd">    &gt;&gt;&gt; print(_is_leap(years, &#39;decimal&#39;))</span>
<span class="sd">    [False, True]</span>
<span class="sd">    &gt;&gt;&gt; print(_is_leap(years, &#39;Excel&#39;))</span>
<span class="sd">    [True, True]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myear</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1990</span><span class="p">)</span>

    <span class="c1"># set calendar-specific defaults for has_year_zero</span>
    <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">_year_zero_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">and</span> <span class="p">(</span><span class="n">calendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;year 0 not allowed with Excel calendars&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">myear</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_year_zero</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;year 0 does not exist in the calendar </span><span class="si">{</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># If there is no year 0 in the calendar, years -1, -5, -9, etc.</span>
    <span class="c1"># are leap years. year 0 is a leap year if it exists.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_year_zero</span><span class="p">:</span>
        <span class="n">myear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">myear</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">myear</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">myear</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">:</span>
        <span class="c1"># Excel calendars are supposedly Julian calendars</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="p">(</span><span class="n">myear</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(((</span><span class="n">myear</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">myear</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
                 <span class="p">((</span><span class="n">myear</span> <span class="o">%</span> <span class="mi">400</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;decimal360&#39;</span><span class="p">,</span> <span class="s1">&#39;decimal365&#39;</span><span class="p">]:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">myear</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal366&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">myear</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">oleap</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">leap</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">oleap</span>


<span class="k">def</span> <span class="nf">_month_lengths</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Number of days of the 12 months in specific year for a given calendar</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    year : int</span>
<span class="sd">        Year to inquire</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the supported calendar names in *_noncfcalendars*</span>
<span class="sd">    has_year_zero : bool, optional</span>
<span class="sd">        Astronomical year numbering is used, i.e. year zero exists, if True</span>
<span class="sd">        and possible for the given *calendar*. If *None* (default),</span>
<span class="sd">        calendar-specific defaults are assumed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">       Lengths of the 12 months in specified *year*</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; print(_month_lengths(1990, &#39;decimal&#39;))</span>
<span class="sd">    [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]</span>
<span class="sd">    &gt;&gt;&gt; print(_month_lengths(1990, &#39;decimal360&#39;))</span>
<span class="sd">    [30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30, 30]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">leap</span> <span class="o">=</span> <span class="n">_is_leap</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_dayspermonth_360</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">leap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_dayspermonth_leap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_dayspermonth</span>


<span class="k">def</span> <span class="nf">_int_julian_day_from_date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute integer Julian Day from year, month, day, and calendar</span>

<span class="sd">    Allowed calendars are all in *_noncfcalendars*.</span>

<span class="sd">    Excel calendars are supposedly Julian calendars with other reference dates.</span>
<span class="sd">    Julian calendar is hence used for the Excel calendars *excel*, *excel1900*,</span>
<span class="sd">    *excel1904*, i.e. integer julian day is the same number of days since</span>
<span class="sd">    -4713-01-01 12:00:00 in the Julian calendar.</span>

<span class="sd">    Integer julian day in the decimal calendars *decimal*, *decimal360*,</span>
<span class="sd">    *decimal365*, *decimal366* is the number of days after 0000-01-01 12:00:00.</span>

<span class="sd">    If the has_year_zero kwarg is set to True, astronomical year numbering</span>
<span class="sd">    is used and the year zero exists for the decimal calendars.</span>
<span class="sd">    If set to False, then historical year numbering is used and the year 1 is</span>
<span class="sd">    preceded by year -1 and no year zero exists.</span>
<span class="sd">    The defaults (has_year_zero=None) uses astronomical year numbering</span>
<span class="sd">    for the decimal calendars.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calendar</span><span class="p">:</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">_year_zero_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
        <span class="c1"># return year * 360 + (month - 1) * 30 + day - 1</span>
        <span class="k">return</span> <span class="n">year</span> <span class="o">*</span> <span class="mi">360</span> <span class="o">+</span> <span class="n">_cumdayspermonth_360</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">day</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal365&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">year</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">+</span> <span class="n">_cumdayspermonth</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">day</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal366&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">year</span> <span class="o">*</span> <span class="mi">366</span> <span class="o">+</span> <span class="n">_cumdayspermonth_leap</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">day</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="n">_is_leap</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">leap</span><span class="p">:</span>
            <span class="n">jday</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">_cumdayspermonth_leap</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jday</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="n">_cumdayspermonth</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># If there is no year 0, years -1, -5, -9, etc,</span>
        <span class="c1"># are leap years. year zero is a leap year if it exists.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_year_zero</span><span class="p">):</span>
            <span class="n">year</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
            <span class="c1"># 1st term is the number of days in the last year</span>
            <span class="c1"># 2nd term is the number of days in each preceding non-leap year</span>
            <span class="c1"># last terms are the number of preceding leap years</span>
            <span class="n">jday_greg</span> <span class="o">=</span> <span class="p">(</span><span class="n">jday</span> <span class="o">+</span> <span class="mi">365</span><span class="o">*</span><span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                         <span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">100</span> <span class="o">+</span> <span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jday_greg</span>
        <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">+=</span> <span class="mi">4800</span>  <span class="c1"># add offset so -4800 is year 0.</span>
            <span class="c1"># 1st term is the number of days in the last year</span>
            <span class="c1"># 2nd term is the number of days in each preceding non-leap year</span>
            <span class="c1"># last terms are the number of preceding leap years</span>
            <span class="n">jday_jul</span> <span class="o">=</span> <span class="n">jday</span> <span class="o">+</span> <span class="mi">365</span><span class="o">*</span><span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">year</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">4</span>
            <span class="c1"># remove offset for 87 years before -4713 (including leap days)</span>
            <span class="n">jday_jul</span> <span class="o">-=</span> <span class="mi">31777</span>
            <span class="k">return</span> <span class="n">jday_jul</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="c1"># Add a datetime.timedelta to a pyjams.datetime instance. Uses</span>
<span class="c1"># integer arithmetic to avoid rounding errors and preserve</span>
<span class="c1"># microsecond accuracy.</span>
<span class="k">def</span> <span class="nf">_add_timedelta</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
    <span class="c1"># extract these inputs here to avoid type conversion in the code below</span>
    <span class="n">delta_microseconds</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">microseconds</span>
    <span class="n">delta_seconds</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span>
    <span class="n">delta_days</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">days</span>

    <span class="c1"># shift microseconds, seconds, days</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">calendar</span>
    <span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span>
    <span class="n">microsecond</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">+</span> <span class="n">delta_microseconds</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span> <span class="o">+</span> <span class="n">delta_seconds</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>

    <span class="n">month_length</span> <span class="o">=</span> <span class="n">_month_lengths</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="p">)</span>

    <span class="c1"># Normalize microseconds, seconds, minutes, hours.</span>
    <span class="n">second</span> <span class="o">+=</span> <span class="n">microsecond</span> <span class="o">//</span> <span class="mi">1000000</span>
    <span class="n">microsecond</span> <span class="o">=</span> <span class="n">microsecond</span> <span class="o">%</span> <span class="mi">1000000</span>
    <span class="n">minute</span> <span class="o">+=</span> <span class="n">second</span> <span class="o">//</span> <span class="mi">60</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">second</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">hour</span> <span class="o">+=</span> <span class="n">minute</span> <span class="o">//</span> <span class="mi">60</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">minute</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">extra_days</span> <span class="o">=</span> <span class="n">hour</span> <span class="o">//</span> <span class="mi">24</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">hour</span> <span class="o">%</span> <span class="mi">24</span>

    <span class="n">delta_days</span> <span class="o">+=</span> <span class="n">extra_days</span>

    <span class="k">while</span> <span class="n">delta_days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># not done compared to cftime because Excel dates &gt; 1900 and</span>
        <span class="c1"># decimal dates include 1582-10-05 to 1582-10-14</span>
        <span class="c1"># if (year == 1582 and month == 10 and day &gt; 14 and</span>
        <span class="c1">#     day + delta_days &lt; 15):</span>
        <span class="c1">#     delta_days -= n_invalid_dates    # skip over invalid dates</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day</span> <span class="o">+</span> <span class="n">delta_days</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">delta_days</span> <span class="o">+=</span> <span class="n">day</span>
            <span class="c1"># decrement month</span>
            <span class="n">month</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">month</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">=</span> <span class="mi">12</span>
                <span class="n">year</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_year_zero</span><span class="p">):</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">month_length</span> <span class="o">=</span> <span class="n">_month_lengths</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="p">)</span>
            <span class="n">day</span> <span class="o">=</span> <span class="n">month_length</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">day</span> <span class="o">+=</span> <span class="n">delta_days</span>
            <span class="n">delta_days</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">delta_days</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># not done compared to cftime because Excel dates &gt; 1900 and</span>
        <span class="c1"># decimal dates include 1582-10-05 to 1582-10-14</span>
        <span class="c1"># if (year == 1582 and month == 10 and day &lt; 5 and</span>
        <span class="c1">#     day + delta_days &gt; 4):</span>
        <span class="c1">#     delta_days += n_invalid_dates    # skip over invalid dates</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">day</span> <span class="o">+</span> <span class="n">delta_days</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">month_length</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">delta_days</span> <span class="o">-=</span> <span class="n">month_length</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">day</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># increment month</span>
            <span class="n">month</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">month</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">year</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">has_year_zero</span><span class="p">):</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">month_length</span> <span class="o">=</span> <span class="n">_month_lengths</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="p">)</span>
            <span class="n">day</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">day</span> <span class="o">+=</span> <span class="n">delta_days</span>
            <span class="n">delta_days</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># New routines</span>
<span class="c1">#</span>

<span class="k">def</span> <span class="nf">_units_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set calendar specific default units as &#39;days since reference_date&#39;</span>

<span class="sd">    Day 0 of *excel* and *excel1900* starts at 1899-12-31 00:00:00.</span>

<span class="sd">    Day 0 of *excel1904* starts at 1903-12-31 00:00:00.</span>

<span class="sd">    Decimal calendars *decimal*, *decimal360*, *decimal365*, and</span>
<span class="sd">    *decimal366* do not need units so 0001-01-01 00:00:00 is taken.</span>

<span class="sd">    Day 0 of *julian*, *gregorian* and *standard* starts at</span>
<span class="sd">    -4713-01-01 12:00:00 if not has_year_zero, and at</span>
<span class="sd">    -4712-01-01 12:00:00 if has_year_zero.</span>

<span class="sd">    Day 0 of *proleptic_gregorian* starts at</span>
<span class="sd">    -4714-11-24 12:00:00 if not has_year_zero, and at</span>
<span class="sd">    -4713-11-24 12:00:00 if has_year_zero.</span>

<span class="sd">    Day 0 of *360_day*, *365_day*, *366_day*, *all_leap*, and</span>
<span class="sd">    *noleap* starts at 0000-01-01 12:00:00.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the supported calendar names in *_cfcalendars* and</span>
<span class="sd">        *_noncfcalendars*</span>
<span class="sd">    has_year_zero : bool, optional</span>
<span class="sd">        Astronomical year numbering is used, i.e. year zero exists, if True</span>
<span class="sd">        and possible for the given *calendar*. If *None* (default),</span>
<span class="sd">        calendar-specific defaults are assumed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">       &#39;days since reference_date&#39; with calendar-specific reference_date</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; print(_units_defaults(&#39;Excel&#39;))</span>
<span class="sd">    &#39;days since 1899-12-31 00:00:00&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">_year_zero_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="s1">&#39;julian&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">has_year_zero</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;days since -4712-01-01 12:00:00&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;days since -4713-01-01 12:00:00&#39;</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;proleptic_gregorian&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">has_year_zero</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;days since -4713-11-24 12:00:00&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;days since -4714-11-24 12:00:00&#39;</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_idealized_cfcalendars</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;days since 0000-01-01 12:00:00&#39;</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;excel&#39;</span><span class="p">,</span> <span class="s1">&#39;excel1900&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;days since 1899-12-31 00:00:00&#39;</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;excel1904&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="s1">&#39;days since 1903-12-31 00:00:00&#39;</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_decimalcalendars</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;days since 0001-01-01 00:00:00&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_date2decimal</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">calendar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decimal date from datetime object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    date : datetime instance</span>
<span class="sd">        Instance of pyjams.datetime class</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the decimal calendar names *decimal*, *decimal360*,</span>
<span class="sd">        *decimal365*, or *decimal366*</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    longdouble</span>
<span class="sd">       decimal date</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; dt = datetime(1990, 1, 1)</span>
<span class="sd">    &gt;&gt;&gt; dec = _date2decimal(dt, &#39;decimal&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(dec)</span>
<span class="sd">    1990.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">year</span>     <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span>    <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
    <span class="n">day</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">hour</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">minute</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
    <span class="n">second</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="n">msecond</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="n">days_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>
    <span class="n">diy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth</span><span class="p">,</span>
                     <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth_leap</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
                    <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">400</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">days_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span>
        <span class="n">diy</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth_360</span><span class="p">,</span>
                          <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth_360</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal365&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal366&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fleap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">leap</span><span class="p">)</span>
    <span class="n">tday</span>  <span class="o">=</span> <span class="n">diy</span><span class="p">[</span><span class="n">leap</span><span class="p">,</span> <span class="n">month</span><span class="p">]</span> <span class="o">+</span> <span class="n">day</span>
    <span class="n">thour</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">tday</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="mf">24.</span> <span class="o">+</span>
              <span class="n">hour</span> <span class="o">+</span>
              <span class="n">minute</span> <span class="o">/</span> <span class="mf">60.</span> <span class="o">+</span>
              <span class="n">second</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="o">+</span>
              <span class="n">msecond</span> <span class="o">/</span> <span class="mf">3600000000.</span> <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="n">thour</span> <span class="o">/</span> <span class="p">((</span><span class="n">days_year</span> <span class="o">+</span> <span class="n">fleap</span><span class="p">)</span> <span class="o">*</span> <span class="mf">24.</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_dates2decimal</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">calendar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decimal dates from datetime objects</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dates : datetime instance or array_like of datetime instances</span>
<span class="sd">        Instances of pyjams.datetime class</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the decimal calendar names *decimal*, *decimal360*,</span>
<span class="sd">        *decimal365*, or *decimal366*</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like of longdouble</span>
<span class="sd">       decimal dates</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; dt = [datetime(1990, 1, 1), datetime(1991, 1, 1)]</span>
<span class="sd">    &gt;&gt;&gt; dec = _dates2decimal(dt, &#39;decimal&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(dec)</span>
<span class="sd">    [1990., 1991.]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdates</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># wrapper might be slow</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_date2decimal</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">calendar</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">mdates</span> <span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_date2absolute</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Absolute date from datetime object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    date : datetime instance</span>
<span class="sd">        Instances of pyjams.datetime class</span>
<span class="sd">    units : str</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;, &#39;month as %Y%m.%f&#39;, or &#39;year as %Y.%f&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    longdouble</span>
<span class="sd">       absolute date</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; dt = datetime(1990, 1, 1)</span>
<span class="sd">    &gt;&gt;&gt; dec = _date2absolute(dt, &#39;day as %Y%m%d.%f&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(np.around(dec, 1))</span>
<span class="sd">    19900101.0</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">year</span>     <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span>    <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span>
    <span class="n">day</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">hour</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">minute</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
    <span class="n">second</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="n">msecond</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;day as %Y%m</span><span class="si">%d</span><span class="s1">.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">tday</span>  <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10000.</span> <span class="o">+</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">+</span>
                 <span class="n">day</span><span class="p">)</span>
        <span class="n">thour</span> <span class="o">=</span> <span class="p">(</span><span class="n">hour</span> <span class="o">+</span>
                 <span class="n">minute</span> <span class="o">/</span> <span class="mf">60.</span> <span class="o">+</span>
                 <span class="n">second</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="o">+</span>
                 <span class="n">msecond</span> <span class="o">/</span> <span class="mf">3600000000.</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tday</span> <span class="o">+</span> <span class="n">thour</span> <span class="o">/</span> <span class="mf">24.</span>
    <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;month as %Y%m.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
                    <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">400</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_dayspermonth</span><span class="p">,</span>
                         <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_dayspermonth_leap</span> <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
        <span class="n">tmonth</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.</span> <span class="o">+</span>
                  <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>
        <span class="n">thour</span> <span class="o">=</span> <span class="p">(</span><span class="n">day</span> <span class="o">*</span> <span class="mf">24.</span> <span class="o">+</span>
                 <span class="n">hour</span> <span class="o">+</span>
                 <span class="n">minute</span> <span class="o">/</span> <span class="mf">60.</span> <span class="o">+</span>
                 <span class="n">second</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="o">+</span>
                 <span class="n">msecond</span> <span class="o">/</span> <span class="mf">3600000000.</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">tmonth</span> <span class="o">+</span> <span class="n">thour</span> <span class="o">/</span> <span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="n">leap</span><span class="p">,</span> <span class="n">month</span><span class="p">]</span> <span class="o">*</span> <span class="mf">24.</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;year as %Y.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="c1"># same as decimal date</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_date2decimal</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown absolute units: </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_dates2absolute</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Absolute dates from datetime object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dates : datetime instance or array_like of datetime instances</span>
<span class="sd">        Instances of pyjams.datetime class</span>
<span class="sd">    units : str</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;, &#39;month as %Y%m.%f&#39;, or &#39;year as %Y.%f&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    longdouble or array_like of longdouble</span>
<span class="sd">       absolute dates</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; dt = [datetime(1990, 1, 1), datetime(1991, 1, 1)]</span>
<span class="sd">    &gt;&gt;&gt; dec = _dates2absolute(dt, &#39;day as %Y%m%d.%f&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(np.around(dec, 1))</span>
<span class="sd">    [19900101.0, 19910101.0]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdates</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># wrapper might be slow</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_date2absolute</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">mdates</span> <span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_decimal2date</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">calendar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split decimal dates into year, month, day, hour, minute, second,</span>
<span class="sd">    microsecond</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : float or array_like</span>
<span class="sd">        Decimal dates such as 1990.5102</span>
<span class="sd">    calendar : str</span>
<span class="sd">        One of the decimal calendar names *decimal*, *decimal360*,</span>
<span class="sd">        *decimal365*, or *decimal366*</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">       arrays of year, month, day, hour, minute, second, microsecond</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; dec = [1990., 1991.5]</span>
<span class="sd">    &gt;&gt;&gt; yr, mo, dy, hr, mi, sc, ms = _decimal2date(dec, &#39;decimal&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(yr)</span>
<span class="sd">    [1990, 1991]</span>
<span class="sd">    &gt;&gt;&gt; print(mo)</span>
<span class="sd">    [1, 7]</span>
<span class="sd">    &gt;&gt;&gt; print(dy)</span>
<span class="sd">    [1, 3]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># old algorithm does decomposition on all array elements</span>
    <span class="c1"># should try similar to decode_dates_from_array for speed</span>
    <span class="c1"># where decomposition is done for the first (oldest) element only</span>
    <span class="c1"># and then timedeltas are added subsequently</span>
    <span class="n">mtimes</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">mtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># year</span>
    <span class="n">fyear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trunc</span><span class="p">(</span><span class="n">mtimes</span><span class="p">)</span>
    <span class="n">fyear</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mtimes</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">fyear</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">fyear</span><span class="p">)</span>
    <span class="n">year</span> <span class="o">=</span> <span class="n">fyear</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">frac_year</span> <span class="o">=</span> <span class="n">mtimes</span> <span class="o">-</span> <span class="n">fyear</span>
    <span class="n">days_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>
    <span class="n">diy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth</span><span class="p">,</span>
                     <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth_leap</span> <span class="p">])</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
        <span class="n">leap</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
                 <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">400</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fleap</span> <span class="o">=</span> <span class="n">leap</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
        <span class="n">leap</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fleap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
        <span class="n">days_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span>
        <span class="n">diy</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth_360</span><span class="p">,</span>
                          <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cumdayspermonth_360</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal365&#39;</span><span class="p">:</span>
        <span class="n">leap</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fleap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal366&#39;</span><span class="p">:</span>
        <span class="n">leap</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">fleap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown decimal calendar: </span><span class="si">{</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># change to microseconds to catch round-off errors,</span>
    <span class="c1"># i.e. cases 1 microsec less or greater than a second</span>
    <span class="c1"># cf. issue #187 of cftime</span>
    <span class="c1"># day of year in microseconds</span>
    <span class="n">fhoy</span> <span class="o">=</span> <span class="n">frac_year</span> <span class="o">*</span> <span class="p">(</span><span class="n">days_year</span> <span class="o">+</span> <span class="n">fleap</span><span class="p">)</span> <span class="o">*</span> <span class="mf">86400000000.</span>
    <span class="n">ihoy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">fhoy</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="c1"># Done in cftime for issue #187</span>
    <span class="c1"># ihoy = np.where(ihoy%1000000 == 1,</span>
    <span class="c1">#                 np.floor(fhoy).astype(np.int64), ihoy)</span>
    <span class="c1"># ihoy = np.where(ihoy%1000000 == 999999,</span>
    <span class="c1">#                 np.ceil(fhoy).astype(np.int64), ihoy)</span>
    <span class="c1"># microsecond</span>
    <span class="n">msecond</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">1000000</span>
    <span class="n">ihoy</span>    <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">1000000</span>
    <span class="c1"># second</span>
    <span class="n">second</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">ihoy</span>   <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">60</span>
    <span class="c1"># minute</span>
    <span class="n">minute</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">60</span>
    <span class="n">ihoy</span>   <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">60</span>
    <span class="c1"># hour</span>
    <span class="n">hour</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">24</span>
    <span class="n">ihoy</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">24</span>
    <span class="c1"># day and month</span>
    <span class="n">idoy</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">day</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mtimes</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idoy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">diy</span><span class="p">[</span><span class="n">leap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">day</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>   <span class="o">=</span> <span class="n">idoy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">diy</span><span class="p">[</span><span class="n">leap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">msecond</span>


<span class="k">def</span> <span class="nf">_absolute2date</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split date(s) in absolute date format into</span>
<span class="sd">    year, month, day, hour, minute, second, microsecond</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : float or array_like</span>
<span class="sd">        Absolute dates such as 20070102.0034722</span>
<span class="sd">    units : str</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;, &#39;month as %Y%m.%f&#39;, or &#39;year as %Y.%f&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">       arrays of year, month, day, hour, minute, second, microsecond</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; absolut = [20070102.0034722, 20070102.0069444]</span>
<span class="sd">    &gt;&gt;&gt; yr, mo, dy, hr, mi, sc, ms = _absolute2date(absolut,</span>
<span class="sd">    ...                                             &#39;day as %Y%m%d.%f&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(yr)</span>
<span class="sd">    [2007, 2007]</span>
<span class="sd">    &gt;&gt;&gt; print(mi)</span>
<span class="sd">    [5, 10]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># old algorithm does decomposition on all array elements</span>
    <span class="c1"># should try similar to decode_dates_from_array for speed</span>
    <span class="c1"># where decomposition is done for the first (oldest) element only</span>
    <span class="c1"># and then timedeltas are added subsequently</span>
    <span class="n">mtimes</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10101.</span><span class="p">)</span>
    <span class="n">mtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;day as %Y%m</span><span class="si">%d</span><span class="s1">.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="c1"># change to microseconds to catch round-off errors,</span>
        <span class="c1"># i.e. cases 1 microsec less or greater than a second</span>
        <span class="c1"># cf. issue #187 of cftime</span>
        <span class="c1"># day of year in microseconds</span>
        <span class="n">fhoy</span> <span class="o">=</span> <span class="n">mtimes</span> <span class="o">*</span> <span class="mf">86400000000.</span>
        <span class="n">ihoy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">fhoy</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># Done in cftime for issue #187</span>
        <span class="c1"># ihoy = np.where(ihoy%1000000 == 1,</span>
        <span class="c1">#                 np.floor(fhoy).astype(np.int64), ihoy)</span>
        <span class="c1"># ihoy = np.where(ihoy%1000000 == 999999,</span>
        <span class="c1">#                 np.ceil(fhoy).astype(np.int64), ihoy)</span>
        <span class="c1"># microsecond</span>
        <span class="n">msecond</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">1000000</span>
        <span class="n">ihoy</span>    <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">1000000</span>
        <span class="c1"># second</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">60</span>
        <span class="n">ihoy</span>   <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">60</span>
        <span class="c1"># minute</span>
        <span class="n">minute</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">60</span>
        <span class="n">ihoy</span>   <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">60</span>
        <span class="c1"># hour</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">24</span>
        <span class="n">ihoy</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">24</span>
        <span class="c1"># day</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">ihoy</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="c1"># month</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">100</span>
        <span class="n">ihoy</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">100</span>
        <span class="c1"># year</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">ihoy</span>
    <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;month as %Y%m.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="n">fmo</span>     <span class="o">=</span> <span class="n">mtimes</span> <span class="o">%</span> <span class="mf">1.</span>  <span class="c1"># month fraction</span>
        <span class="c1"># month</span>
        <span class="n">mtimes</span> <span class="o">-=</span> <span class="n">fmo</span>
        <span class="n">month</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">mtimes</span> <span class="o">%</span> <span class="mf">100.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># year</span>
        <span class="n">mtimes</span> <span class="o">-=</span> <span class="n">month</span>
        <span class="n">year</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">mtimes</span> <span class="o">/</span> <span class="mf">100.</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># day of month in microseconds</span>
        <span class="n">leap</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
                           <span class="p">((</span><span class="n">year</span> <span class="o">%</span> <span class="mi">400</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dim</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_dayspermonth</span><span class="p">,</span>
                             <span class="p">[</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="n">_dayspermonth_leap</span> <span class="p">])</span>
        <span class="n">fhoy</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[(</span><span class="n">leap</span><span class="p">,</span> <span class="n">month</span><span class="p">)]</span> <span class="o">*</span> <span class="n">fmo</span> <span class="o">*</span> <span class="mf">86400000000.</span>
        <span class="n">ihoy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">fhoy</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># Done in cftime for issue #187</span>
        <span class="c1"># ihoy = np.where(ihoy%1000000 == 1,</span>
        <span class="c1">#                 np.floor(fhoy).astype(np.int64), ihoy)</span>
        <span class="c1"># ihoy = np.where(ihoy%1000000 == 999999,</span>
        <span class="c1">#                 np.ceil(fhoy).astype(np.int64), ihoy)</span>
        <span class="c1"># microsecond</span>
        <span class="n">msecond</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">1000000</span>
        <span class="n">ihoy</span>    <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">1000000</span>
        <span class="c1"># second</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">60</span>
        <span class="n">ihoy</span>   <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">60</span>
        <span class="c1"># minute</span>
        <span class="n">minute</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">60</span>
        <span class="n">ihoy</span>   <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">60</span>
        <span class="c1"># hour</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">%</span> <span class="mi">24</span>
        <span class="n">ihoy</span> <span class="o">=</span> <span class="n">ihoy</span> <span class="o">//</span> <span class="mi">24</span>
        <span class="c1"># day</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">ihoy</span>
        <span class="c1"># mtimes  = dim[(leap, month)] * fmo</span>
        <span class="c1"># fdy     = mtimes % 1.  # day fraction</span>
        <span class="c1"># mtimes -= fdy</span>
        <span class="c1"># day     = np.rint(mtimes % 100.).astype(np.int64)</span>
        <span class="c1"># # hour</span>
        <span class="c1"># secs    = fdy * 86400.</span>
        <span class="c1"># fsecs   = secs % 1.  # second fraction</span>
        <span class="c1"># secs    = np.rint(secs)</span>
        <span class="c1"># hour    = np.floor(secs / 3600.).astype(np.int64)</span>
        <span class="c1"># # minute</span>
        <span class="c1"># secs   -= 3600. * hour</span>
        <span class="c1"># minute  = np.floor(secs / 60.).astype(np.int64)</span>
        <span class="c1"># # second</span>
        <span class="c1"># secs   -= 60. * minute</span>
        <span class="c1"># second  = np.rint(secs).astype(np.int64)</span>
        <span class="c1"># # millisecond</span>
        <span class="c1"># msecond  = np.rint(fsecs * 1000000.).astype(np.int64)</span>
    <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;year as %Y.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">:</span>
        <span class="c1"># same as decimal date</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">msecond</span> <span class="o">=</span> <span class="n">_decimal2date</span><span class="p">(</span>
            <span class="n">times</span><span class="p">,</span> <span class="s1">&#39;decimal&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown absolute units: </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">msecond</span>


<span class="c1">#</span>
<span class="c1"># Main routines and class</span>
<span class="c1">#</span>

<div class="viewcode-block" id="date2num"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.date2num">[docs]</a><span class="k">def</span> <span class="nf">date2num</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">timesep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return numeric time values given datetime objects or strings</span>

<span class="sd">    The units of the numeric time values are described by the</span>
<span class="sd">    *units* and *calendar* keywords for CF-conform calendars, i.e.</span>
<span class="sd">    *standard*, *gregorian*, *julian*, *proleptic_gregorian*,</span>
<span class="sd">    *360_day*, *365_day*, *366_day*, *noleap*, *all_leap*.</span>
<span class="sd">    See http://cfconventions.org/cf-conventions/cf-conventions#calendar</span>
<span class="sd">    These times will be passed to cftime.num2date.</span>

<span class="sd">    Standard *units* are used for the non-CF-conform calendars</span>
<span class="sd">    *excel*, *excel1900*, *excel1904*, and</span>
<span class="sd">    *decimal*, *decimal360*, *decimal365*, *decimal366*,</span>
<span class="sd">    and given *units* will hence be ignored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dates : datetime instance or str, or array_like of datetime or str</span>
<span class="sd">        datetime objects or strings with string representations.</span>
<span class="sd">        datetime objects can either be Python datetime.datetime,</span>
<span class="sd">        cf.datetime, or pyjams.datetime objects. If *dates* are strings,</span>
<span class="sd">        then *format* keyword is relevant.</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Units string such as &#39;seconds since 1900-01-01 00:00:00&#39; or</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;. Standard units corresponding to days after</span>
<span class="sd">        day 0 of a given calendar will be used if omitted, i.e. assuming</span>
<span class="sd">        Julian day ordinals.</span>

<span class="sd">        In the form *time_units since reference_time*,</span>
<span class="sd">        *time_units* can be days, hours, minutes, seconds, milliseconds,</span>
<span class="sd">        or microseconds. *reference_time* is the time origin.</span>
<span class="sd">        *months since* is allowed only for the *360_day* calendar</span>
<span class="sd">        and *common_years since* is allowed only for the *365_day* calendar.</span>

<span class="sd">        There are currently only three valid forms for *time_units as format*:</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;, &#39;month as %Y%m.%f&#39;, &#39;year as %Y.%f&#39;. The latter is</span>
<span class="sd">        the same as &#39;calendar=decimal&#39;. *calendar=&#39;decimal&#39; will be set in</span>
<span class="sd">        case units *time_units as format*.</span>
<span class="sd">    calendar : str, optional</span>
<span class="sd">        One of the supported calendars, i.e. the CF-conform calendars</span>
<span class="sd">        *standard*, *gregorian*, *julian*, *proleptic_gregorian*,</span>
<span class="sd">        *360_day*, *365_day*, *366_day*, *noleap*, *all_leap*,</span>
<span class="sd">        as well as the non-CF-conform calendars</span>
<span class="sd">        *excel*, *excel1900*, *excel1904*, and</span>
<span class="sd">        *decimal*, *decimal360*, *decimal365*, *decimal366*.</span>
<span class="sd">        *standard* will be taken by default, which is a mixed</span>
<span class="sd">        Julian/Gregorian calendar.</span>
<span class="sd">        The keyword takes precedence on calendar in datetime objects. </span>
<span class="sd">    has_year_zero : bool, optional</span>
<span class="sd">        Astronomical year numbering is used and the year zero exists, if set to</span>
<span class="sd">        True. If set to False for real-world calendars, then historical year</span>
<span class="sd">        numbering is used and the year 1 is preceded by year -1 and no year</span>
<span class="sd">        zero exists.</span>
<span class="sd">        The defaults are set to conform with CF version 1.9 conventions, i.e.</span>
<span class="sd">        False for &#39;standard&#39;, &#39;gregorian&#39;, and &#39;julian&#39;, True</span>
<span class="sd">        for &#39;proleptic_gregorian&#39; (ISO 8601), and True for the idealized</span>
<span class="sd">        calendars &#39;noleap&#39;/&#39;365_day&#39;, &#39;360_day&#39;, 366_day&#39;/&#39;all_leap&#39;.</span>
<span class="sd">        Excel calendars *excel*, *excel1900*, *excel1904* start only 1900</span>
<span class="sd">        or above so *has_year_zero* is always False.</span>
<span class="sd">        Decimal calendars *decimal*, *decimal360*, *decimal365*, *decimal366*</span>
<span class="sd">        have always year 0, i.e. *has_year_zero* is True.</span>
<span class="sd">    format : str, optional</span>
<span class="sd">        If *dates* are strings, then *format* is the Python</span>
<span class="sd">        datetime.strftime/strptime format string if given. If empty (default),</span>
<span class="sd">        then the routine pyjams.date2date will be used, which converts between</span>
<span class="sd">        formats &#39;%Y-%m-%d %H:%M:%S&#39;, &#39;%d.%m.%Y %H:%M:%S&#39;, and &#39;%m/%d/%Y</span>
<span class="sd">        %H:%M:%S&#39; (called English *YYYY-MM-DD hh:mm:ss*, standard</span>
<span class="sd">        *DD.MM.YYYY hh:mm:ss*, and American *MM/DD/YYYY hh:mm:ss* in</span>
<span class="sd">        pyjams.date2date), where times can be partial or missing.</span>
<span class="sd">    timesep : str, optional</span>
<span class="sd">        Separator string between date and time used by pyjams.date2date if</span>
<span class="sd">        if *dates* are strings and *format* is empty (default: &#39; &#39;)</span>
<span class="sd">    fr : bool, optional</span>
<span class="sd">        If True, pyjams.date2date will interpret input dates with &#39;/&#39;</span>
<span class="sd">        separators not as the American format &#39;%m/%d/%Y %H:%M:%S&#39; but the</span>
<span class="sd">        French way as &#39;%d/%m/%Y %H:%M:%S&#39;, if *dates* are strings and</span>
<span class="sd">        *format* is empty</span>
<span class="sd">    return_arrays : bool, optional</span>
<span class="sd">        If True, then return a tuple with individual arrays for</span>
<span class="sd">        year, month, day, hour, minute, second, microsecond</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">       numeric time values</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; idates = [&#39;2000-01-05 12:30:15&#39;, &#39;1810-04-24 16:15:10&#39;,</span>
<span class="sd">    ...           &#39;1630-07-15 10:20:40&#39;, &#39;1510-09-20 14:35:50&#39;,</span>
<span class="sd">    ...           &#39;1271-03-18 19:41:34&#39;, &#39;0619-08-27 11:08:37&#39;,</span>
<span class="sd">    ...           &#39;0001-01-01 12:00:00&#39;]</span>
<span class="sd">    &gt;&gt;&gt; decimal = date2num(idates, calendar=&#39;decimal&#39;)</span>
<span class="sd">    &gt;&gt;&gt; num2date(decimal, calendar=&#39;decimal&#39;, format=&#39;%Y-%m-%d %H:%M:%S&#39;)</span>
<span class="sd">    [&#39;2000-01-05 12:30:15&#39;,</span>
<span class="sd">     &#39;1810-04-24 16:15:10&#39;,</span>
<span class="sd">     &#39;1630-07-15 10:20:40&#39;,</span>
<span class="sd">     &#39;1510-09-20 14:35:50&#39;,</span>
<span class="sd">     &#39;1271-03-18 19:41:34&#39;,</span>
<span class="sd">     &#39;0619-08-27 11:08:37&#39;,</span>
<span class="sd">     &#39;0001-01-01 12:00:00&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">dates</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date0</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iform</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">iform</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mdates</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>

    <span class="c1"># datetime with calendar</span>
    <span class="n">date0</span> <span class="o">=</span> <span class="n">mdates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">icalendar</span> <span class="o">=</span> <span class="n">calendar</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">icalendar</span> <span class="o">=</span> <span class="n">date0</span><span class="o">.</span><span class="n">calendar</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># take standard otherwise</span>
            <span class="n">icalendar</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>

    <span class="k">if</span> <span class="n">icalendar</span><span class="p">:</span>
        <span class="n">icalendar</span> <span class="o">=</span> <span class="n">icalendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">icalendar</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">icalendar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_cfcalendars</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">icalendar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_noncfcalendars</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="n">icalendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">_units_defaults</span><span class="p">(</span><span class="n">icalendar</span><span class="p">)</span>

    <span class="c1"># transform strings to datetime objects</span>
    <span class="c1"># only possible for year &gt; 0</span>
    <span class="n">isstr</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">mdates</span> <span class="p">])</span>
    <span class="k">if</span> <span class="n">isstr</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdates</span> <span class="o">=</span> <span class="n">date2date</span><span class="p">(</span><span class="n">mdates</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">timesep</span><span class="o">=</span><span class="n">timesep</span><span class="p">,</span> <span class="n">fr</span><span class="o">=</span><span class="n">fr</span><span class="p">)</span>
            <span class="n">iform</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>
        <span class="n">mmdates</span> <span class="o">=</span> <span class="p">[</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">iform</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">mdates</span> <span class="p">]</span>

        <span class="k">if</span> <span class="n">icalendar</span> <span class="ow">in</span> <span class="n">_cfcalendars</span><span class="p">:</span>
            <span class="n">mmdates</span> <span class="o">=</span> <span class="p">[</span> <span class="n">cf</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">calendar</span><span class="o">=</span><span class="n">icalendar</span><span class="p">,</span>
                                    <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">mmdates</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mmdates</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">calendar</span><span class="o">=</span><span class="n">icalendar</span><span class="p">,</span>
                                 <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">mmdates</span> <span class="p">]</span>
        <span class="n">mdates</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">mmdates</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">cf</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdates</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># if year, month, ... wanted, no need to go further</span>
    <span class="k">if</span> <span class="n">return_arrays</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">mdates</span> <span class="p">])</span>
        <span class="n">year</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="n">month</span>       <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="n">day</span>         <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="n">hour</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="n">minute</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="n">second</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="n">microsecond</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">dates</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span>

    <span class="c1"># check if we can parse to cftime</span>
    <span class="k">if</span> <span class="n">icalendar</span> <span class="ow">in</span> <span class="n">_cfcalendars</span><span class="p">:</span>
        <span class="n">iscf</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">icalendar</span> <span class="ow">in</span> <span class="n">_noncfcalendars</span><span class="p">:</span>
        <span class="n">iscf</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="c1"># should be impossible to reach</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="n">icalendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">unit</span><span class="p">,</span> <span class="n">sincestr</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">_datesplit</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sincestr</span> <span class="o">==</span> <span class="s1">&#39;as&#39;</span><span class="p">:</span>
        <span class="n">iscf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">icalendar</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># use cftime.date2num if possible</span>
    <span class="k">if</span> <span class="n">iscf</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">remainder</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">remainder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_year_zero</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">mdates</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">icalendar</span><span class="p">,</span>
                          <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sincestr</span> <span class="o">==</span> <span class="s1">&#39;as&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;day as %Y%m</span><span class="si">%d</span><span class="s1">.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;month as %Y%m.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;year as %Y.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute date format unknown: </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_dates2absolute</span><span class="p">(</span><span class="n">mdates</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

    <span class="c1"># use cftime.date2num with Excel</span>
    <span class="k">if</span> <span class="n">icalendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">:</span>
        <span class="n">cfcalendar</span> <span class="o">=</span> <span class="s1">&#39;julian&#39;</span>
        <span class="n">cfdates</span> <span class="o">=</span> <span class="p">[</span> <span class="n">cf</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">calendar</span><span class="o">=</span><span class="n">cfcalendar</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">mdates</span> <span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">cfdates</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">cfcalendar</span><span class="p">,</span>
                          <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>

    <span class="c1"># no cftime.num2date possible</span>
    <span class="k">if</span> <span class="n">icalendar</span> <span class="ow">in</span> <span class="n">_decimalcalendars</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_dates2decimal</span><span class="p">(</span><span class="n">mdates</span><span class="p">,</span> <span class="n">icalendar</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="date2dec"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.date2dec">[docs]</a><span class="k">def</span> <span class="nf">date2dec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for :func:`date2num`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">date2num</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="num2date"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.num2date">[docs]</a><span class="k">def</span> <span class="nf">num2date</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
             <span class="n">only_use_cftime_datetimes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">only_use_python_datetimes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">return_arrays</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return datetime objects given numeric time values</span>

<span class="sd">    The units of the numeric time values are described by the</span>
<span class="sd">    *units* and *calendar* keywords for CF-conform calendars, i.e.</span>
<span class="sd">    *standard*, *gregorian*, *julian*, *proleptic_gregorian*,</span>
<span class="sd">    *360_day*, *365_day*, *366_day*, *noleap*, *all_leap*.</span>
<span class="sd">    See http://cfconventions.org/cf-conventions/cf-conventions#calendar</span>
<span class="sd">    These times will be passed to cftime.num2date.</span>

<span class="sd">    Standard *units* are used for the non-CF-conform calendars</span>
<span class="sd">    *excel*, *excel1900*, *excel1904*, and</span>
<span class="sd">    *decimal*, *decimal360*, *decimal365*, *decimal366*,</span>
<span class="sd">    and given *units* will hence be ignored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : float or array_like</span>
<span class="sd">        Numeric time values</span>
<span class="sd">    units : str, optional</span>
<span class="sd">        Units string such as &#39;seconds since 1900-01-01 00:00:00&#39; or</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;. Standard units corresponding to days after</span>
<span class="sd">        day 0 of a given calendar will be used if omitted, i.e. assuming</span>
<span class="sd">        Julian day ordinals.</span>

<span class="sd">        In the form *time_units since reference_time*,</span>
<span class="sd">        *time_units* can be days, hours, minutes, seconds, milliseconds,</span>
<span class="sd">        or microseconds. *reference_time* is the time origin.</span>
<span class="sd">        *months since* is allowed only for the *360_day* calendar</span>
<span class="sd">        and *common_years since* is allowed only for the *365_day* calendar.</span>

<span class="sd">        There are currently only three valid forms for *time_units as format*:</span>
<span class="sd">        &#39;day as %Y%m%d.%f&#39;, &#39;month as %Y%m.%f&#39;, &#39;year as %Y.%f&#39;. The latter is</span>
<span class="sd">        the same as &#39;calendar=decimal&#39;. *calendar=&#39;decimal&#39; will be set in</span>
<span class="sd">        case units *time_units as format*.</span>
<span class="sd">    calendar : str, optional</span>
<span class="sd">        One of the support calendars, i.e. the CF-conform calendars</span>
<span class="sd">        *standard*, *gregorian*, *julian*, *proleptic_gregorian*,</span>
<span class="sd">        *360_day*, *365_day*, *366_day*, *noleap*, *all_leap*,</span>
<span class="sd">        as well as the non-CF-conform calendars</span>
<span class="sd">        *excel*, *excel1900*, *excel1904*, and</span>
<span class="sd">        *decimal*, *decimal360*, *decimal365*, *decimal366*.</span>
<span class="sd">        *standard* will be taken by default, which is a mixed</span>
<span class="sd">        Julian/Gregorian calendar.</span>
<span class="sd">    only_use_cftime_datetimes : bool, optional</span>
<span class="sd">        pyjams.datetime and cftime.datetime objects are returned by default.</span>
<span class="sd">        Only if only_use_cftime_datetimes is set to False (default: True)</span>
<span class="sd">        and only_use_python_datetimes is set to True then Python</span>
<span class="sd">        datetime.datetime objects will be returned where possible.</span>
<span class="sd">    only_use_python_datetimes : bool, optional</span>
<span class="sd">        pyjams.datetime and cftime.datetime objects are returned by default.</span>
<span class="sd">        Only if only_use_python_datetimes is set to True (default: False)</span>
<span class="sd">        and only_use_cftime_datetimes is set to False then Python</span>
<span class="sd">        datetime.datetime objects will be returned where possible.</span>
<span class="sd">    has_year_zero : bool, optional</span>
<span class="sd">        Astronomical year numbering is used and the year zero exists, if set to</span>
<span class="sd">        True. If set to False for real-world calendars, then historical year</span>
<span class="sd">        numbering is used and the year 1 is preceded by year -1 and no year</span>
<span class="sd">        zero exists.</span>
<span class="sd">        The defaults are set to conform with CF version 1.9 conventions, i.e.</span>
<span class="sd">        False for &#39;standard&#39;, &#39;gregorian&#39;, and &#39;julian&#39;, True</span>
<span class="sd">        for &#39;proleptic_gregorian&#39; (ISO 8601), and True for the idealized</span>
<span class="sd">        calendars &#39;noleap&#39;/&#39;365_day&#39;, &#39;360_day&#39;, 366_day&#39;/&#39;all_leap&#39;.</span>
<span class="sd">        Excel calendars *excel*, *excel1900*, *excel1904* start only 1900</span>
<span class="sd">        or above so *has_year_zero* is always False.</span>
<span class="sd">        Decimal calendars *decimal*, *decimal360*, *decimal365*, *decimal366*</span>
<span class="sd">        have always year 0, i.e. *has_year_zero* is True.</span>
<span class="sd">    format : str, optional</span>
<span class="sd">        If format string is given than a string representation of the</span>
<span class="sd">        datetime objects will be returned.</span>
<span class="sd">    return_arrays : bool, optional</span>
<span class="sd">        If True, then return a tuple with individual arrays for</span>
<span class="sd">        year, month, day, hour, minute, second, microsecond</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array_like</span>
<span class="sd">       datetime instances or string representations of datetime objects, or</span>
<span class="sd">       tuple with individual arrays for year, month, day, hour, minute,</span>
<span class="sd">       second, microsecond</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; idates = [&#39;2000-01-05 12:30:15&#39;, &#39;1810-04-24 16:15:10&#39;,</span>
<span class="sd">    ...           &#39;1630-07-15 10:20:40&#39;, &#39;1510-09-20 14:35:50&#39;,</span>
<span class="sd">    ...           &#39;1271-03-18 19:41:34&#39;, &#39;0619-08-27 11:08:37&#39;,</span>
<span class="sd">    ...           &#39;0001-01-01 12:00:00&#39;]</span>
<span class="sd">    &gt;&gt;&gt; decimal = date2num(idates, calendar=&#39;decimal&#39;)</span>
<span class="sd">    &gt;&gt;&gt; num2date(decimal, calendar=&#39;decimal&#39;, format=&#39;%Y-%m-%d %H:%M:%S&#39;)</span>
<span class="sd">    [&#39;2000-01-05 12:30:15&#39;,</span>
<span class="sd">     &#39;1810-04-24 16:15:10&#39;,</span>
<span class="sd">     &#39;1630-07-15 10:20:40&#39;,</span>
<span class="sd">     &#39;1510-09-20 14:35:50&#39;,</span>
<span class="sd">     &#39;1271-03-18 19:41:34&#39;,</span>
<span class="sd">     &#39;0619-08-27 11:08:37&#39;,</span>
<span class="sd">     &#39;0001-01-01 12:00:00&#39;]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="ow">and</span> <span class="n">return_arrays</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Keywords format and return_arrays mutually&#39;</span>
                         <span class="s1">&#39; exclusive&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calendar</span><span class="p">:</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
    <span class="c1"># check if we can parse to cftime</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_cfcalendars</span><span class="p">:</span>
        <span class="n">iscf</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_noncfcalendars</span><span class="p">:</span>
        <span class="n">iscf</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">_units_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">)</span>
    <span class="n">unit</span><span class="p">,</span> <span class="n">sincestr</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">_datesplit</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sincestr</span> <span class="o">==</span> <span class="s1">&#39;as&#39;</span><span class="p">:</span>
        <span class="n">iscf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">mtimes</span> <span class="o">=</span> <span class="n">input2array</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># use cftime.num2date if possible</span>
    <span class="k">if</span> <span class="n">iscf</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">remainder</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">only_use_python_datetimes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">remainder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">only_use_python_datetimes</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_year_zero</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span>
            <span class="n">mtimes</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">calendar</span><span class="p">,</span>
            <span class="n">only_use_cftime_datetimes</span><span class="o">=</span><span class="n">only_use_cftime_datetimes</span><span class="p">,</span>
            <span class="n">only_use_python_datetimes</span><span class="o">=</span><span class="n">only_use_python_datetimes</span><span class="p">,</span>
            <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>

    <span class="c1"># cdo absolute time format</span>
    <span class="k">if</span> <span class="n">sincestr</span> <span class="o">==</span> <span class="s1">&#39;as&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;day as %Y%m</span><span class="si">%d</span><span class="s1">.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;month as %Y%m.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;year as %Y.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absolute date format unknown: </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># old algorithm does decomposition on all array elements</span>
        <span class="c1"># should try similar to decode_dates_from_array for speed</span>
        <span class="c1"># where decomposition is done for the first (oldest) element only</span>
        <span class="c1"># and then timedeltas are added subsequently</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_absolute2date</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">units</span><span class="p">))</span>

        <span class="c1"># shortcut</span>
        <span class="k">if</span> <span class="n">return_arrays</span><span class="p">:</span>
            <span class="n">year</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">month</span>       <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">day</span>         <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">hour</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">minute</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">minute</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">second</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">microsecond</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="ow">not</span> <span class="n">only_use_cftime_datetimes</span><span class="p">)</span> <span class="ow">and</span>
             <span class="n">only_use_python_datetimes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">day</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">hour</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">minute</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">microsecond</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">day</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">hour</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">minute</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">microsecond</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;decimal&#39;</span><span class="p">,</span>
                                  <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>

    <span class="c1"># use cftime.num2date for Excel but return pyjams.datetime</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">:</span>
        <span class="n">cfcalendar</span> <span class="o">=</span> <span class="s1">&#39;julian&#39;</span>
        <span class="n">cfunits</span> <span class="o">=</span> <span class="n">_units_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">)</span>
        <span class="n">cfdates</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span>
            <span class="n">mtimes</span><span class="p">,</span> <span class="n">cfunits</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="n">cfcalendar</span><span class="p">,</span>
            <span class="n">only_use_cftime_datetimes</span><span class="o">=</span><span class="n">only_use_cftime_datetimes</span><span class="p">,</span>
            <span class="n">only_use_python_datetimes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>

        <span class="c1"># shortcut</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="c1"># Assure 4 digit years on all platforms</span>
            <span class="c1"># see https://github.com/python/cpython/issues/76376</span>
            <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
            <span class="k">if</span> <span class="s1">&#39;%Y&#39;</span> <span class="ow">in</span> <span class="nb">format</span><span class="p">:</span>
                <span class="n">format04</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%04Y&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dttest</span> <span class="o">=</span> <span class="n">cfdates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format04</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;4Y&#39;</span> <span class="ow">in</span> <span class="n">dttest</span><span class="p">:</span>
                        <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">iform</span> <span class="o">=</span> <span class="n">format04</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">iform</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">cfdates</span> <span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">calendar</span><span class="o">=</span><span class="n">calendar</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">cfdates</span> <span class="p">]</span>

    <span class="c1"># no cftime.num2date possible</span>
    <span class="k">if</span> <span class="n">calendar</span> <span class="ow">in</span> <span class="n">_decimalcalendars</span><span class="p">:</span>
        <span class="c1"># old algorithm does decomposition on all array elements</span>
        <span class="c1"># should try similar to decode_dates_from_array for speed</span>
        <span class="c1"># where decomposition is done for the first (oldest) element only</span>
        <span class="c1"># and then timedeltas are added subsequently</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">_decimal2date</span><span class="p">(</span><span class="n">mtimes</span><span class="p">,</span> <span class="n">calendar</span><span class="p">))</span>

        <span class="c1"># shortcut</span>
        <span class="k">if</span> <span class="n">return_arrays</span><span class="p">:</span>
            <span class="n">year</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">month</span>       <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">day</span>         <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">hour</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">minute</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">minute</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">second</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="n">microsecond</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="ow">not</span> <span class="n">only_use_cftime_datetimes</span><span class="p">)</span> <span class="ow">and</span>
             <span class="n">only_use_python_datetimes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">day</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">hour</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">minute</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">microsecond</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">month</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">day</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">hour</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">minute</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">microsecond</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                  <span class="n">calendar</span><span class="o">=</span><span class="n">calendar</span><span class="p">,</span>
                                  <span class="n">has_year_zero</span><span class="o">=</span><span class="n">has_year_zero</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_arrays</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">out</span> <span class="p">])</span>
        <span class="n">year</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">month</span>       <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">day</span>         <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">hour</span>        <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">minute</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">second</span>      <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">microsecond</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
            <span class="c1"># Assure 4 digit years on all platforms</span>
            <span class="c1"># see https://github.com/python/cpython/issues/76376</span>
            <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
            <span class="k">if</span> <span class="s1">&#39;%Y&#39;</span> <span class="ow">in</span> <span class="nb">format</span><span class="p">:</span>
                <span class="n">years0</span> <span class="o">=</span> <span class="p">[</span> <span class="n">dd</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">out</span> <span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">years0</span><span class="p">):</span>
                    <span class="n">y4</span> <span class="o">=</span> <span class="s1">&#39;%05Y&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y4</span> <span class="o">=</span> <span class="s1">&#39;%04Y&#39;</span>
                <span class="n">format04</span> <span class="o">=</span> <span class="nb">format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="n">y4</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dttest</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format04</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;4Y&#39;</span> <span class="ow">in</span> <span class="n">dttest</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;5Y&#39;</span> <span class="ow">in</span> <span class="n">dttest</span><span class="p">):</span>
                        <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">iform</span> <span class="o">=</span> <span class="n">format04</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">iform</span> <span class="o">=</span> <span class="nb">format</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">iform</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">out</span> <span class="p">]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">array2input</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<span class="k">def</span> <span class="nf">dec2date</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for :func:`num2date`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">num2date</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Could not inherit from cf.datetime because all methods are read-only,</span>
<span class="c1"># so had to re-code all methods, even identical ones</span>
<div class="viewcode-block" id="datetime"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime">[docs]</a><span class="k">class</span> <span class="nc">datetime</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class mimics cftime.datetime but for non-CF-conform calendars</span>

<span class="sd">    The cftime.datetime class mimics itself datetime.datetime but</span>
<span class="sd">    supports calendars other than the proleptic Gregorian calendar.</span>

<span class="sd">    This class supports timedelta operations by overloading +/-, and</span>
<span class="sd">    comparisons with other instances using the same calendar.</span>

<span class="sd">    Current supported calendars are *excel*, *excel1900*, *excel1904*,</span>
<span class="sd">    and *decimal*, *decimal360*, *decimal365*, *decimal366*. Excel</span>
<span class="sd">    calendars are supposedly Julian calendars with other reference dates.</span>
<span class="sd">    Day 0 of *excel*/*excel1900* starts at 1899-12-31 00:00:00 and day 0</span>
<span class="sd">    of *excel1904* (old Lotus date) starts at 1903-12-31 00:00:00.</span>
<span class="sd">    Decimal calendars have the form &quot;%Y.%f&quot;, where the fractional year</span>
<span class="sd">    assumes leap years as the proleptic Gregorian calendar, or fixed 360,</span>
<span class="sd">    365, or 366 days per year.</span>

<span class="sd">    If the has_year_zero keyword argument is set to True, astronomical year</span>
<span class="sd">    numbering is used and the year zero exists, which is the default for the</span>
<span class="sd">    decimal calendars. The keyword will be ignored for Excel calendars.</span>

<span class="sd">    The class has the methods isoformat, strftime, timetuple, replace,</span>
<span class="sd">    dayofwk, dayofyr, daysinmonth, __repr__, __format__, __add__, __sub__,</span>
<span class="sd">    __str__, and comparison methods.</span>

<span class="sd">    The default format of the string produced by strftime is controlled by</span>
<span class="sd">    self.format (default %Y-%m-%d %H:%M:%S).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Python&#39;s datetime.datetime uses the proleptic Gregorian</span>
    <span class="c1"># calendar. This boolean is used to decide whether a</span>
    <span class="c1"># cftime.datetime instance can be converted to</span>
    <span class="c1"># datetime.datetime.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                 <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">dayofwk</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dayofyr</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;decimal&#39;</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise new datetime instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">month</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hour</span> <span class="o">=</span> <span class="n">hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minute</span> <span class="o">=</span> <span class="n">minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">=</span> <span class="n">microsecond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dayofwk</span> <span class="o">=</span> <span class="n">dayofwk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dayofyr</span> <span class="o">=</span> <span class="n">dayofyr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tzinfo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">calendar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;decimal&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="ow">in</span> <span class="n">_cfcalendars</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Use cftime.datetime for CF-conform&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39; calendars: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_year_zero</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">_year_zero_defaults</span><span class="p">(</span><span class="n">calendar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">has_year_zero</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_noncfcalendars</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown calendar: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="ow">in</span> <span class="n">_excelcalendars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datetime_compatible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datetime_compatible</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_valid_date</span><span class="p">()</span>

<div class="viewcode-block" id="datetime.assert_valid_date"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.assert_valid_date">[docs]</a>    <span class="k">def</span> <span class="nf">assert_valid_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that datetime is a valid date for given calendar</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># year</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid year provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c1"># Comment next block to allow negative days with Excel calendars,</span>
        <span class="c1"># which does not exist in Excel</span>
        <span class="c1"># if ( ((self.calendar == &#39;excel&#39;) or (self.calendar == &#39;excel1900&#39;)) and</span>
        <span class="c1">#      self.year &lt; 1900):</span>
        <span class="c1">#     raise ValueError(&#39;Year must be &gt;= 1900 for Excel dates&#39;)</span>
        <span class="c1"># if ( (self.calendar == &#39;excel1904&#39;) and self.year &lt; 1904):</span>
        <span class="c1">#     raise ValueError(&#39;Year must be &gt;= 1904 for Excel1904 dates&#39;)</span>

        <span class="c1"># month</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid month provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># day</span>
        <span class="n">month_length</span> <span class="o">=</span> <span class="n">_month_lengths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="n">month_length</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid day number provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># hour</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hour</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hour</span> <span class="o">&gt;</span> <span class="mi">23</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid hour provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># minute</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minute</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minute</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid minute provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># second</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second</span> <span class="o">&gt;</span> <span class="mi">59</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid second provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># microsecond</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">&gt;</span> <span class="mi">999999</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid microsecond provided in </span><span class="si">{0!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="datetime.change_calendar"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.change_calendar">[docs]</a>    <span class="k">def</span> <span class="nf">change_calendar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span></div>

<div class="viewcode-block" id="datetime.dayofwk"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.dayofwk">[docs]</a>    <span class="k">def</span> <span class="nf">dayofwk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Day of the week</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dayofwk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">:</span>
            <span class="n">ord0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
                <span class="n">ord0</span> <span class="o">=</span> <span class="mi">1721425</span>
            <span class="n">jd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">+</span> <span class="n">ord0</span>
            <span class="n">dayofwk</span> <span class="o">=</span> <span class="p">(</span><span class="n">jd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
            <span class="c1"># convert to ISO 8601 (0 = Monday, 6 = Sunday), like python</span>
            <span class="c1"># datetime</span>
            <span class="n">dayofwk</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dayofwk</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">dayofwk</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="c1"># cache results for dayofwk</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dayofwk</span> <span class="o">=</span> <span class="n">dayofwk</span>
            <span class="k">return</span> <span class="n">dayofwk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dayofwk</span></div>

<div class="viewcode-block" id="datetime.dayofyr"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.dayofyr">[docs]</a>    <span class="k">def</span> <span class="nf">dayofyr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Day of year</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dayofyr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
                <span class="c1"># dayofyr = (self.month - 1) * 30 + self.day</span>
                <span class="n">dayofyr</span> <span class="o">=</span> <span class="n">_cumdayspermonth_360</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_is_leap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
                            <span class="n">has_year_zero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">):</span>
                    <span class="n">dayofyr</span> <span class="o">=</span> <span class="n">_cumdayspermonth_leap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dayofyr</span> <span class="o">=</span> <span class="n">_cumdayspermonth</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span>
            <span class="c1"># cache results for dayofyr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dayofyr</span> <span class="o">=</span> <span class="n">dayofyr</span>
            <span class="k">return</span> <span class="n">dayofyr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dayofyr</span></div>

<div class="viewcode-block" id="datetime.daysinmonth"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.daysinmonth">[docs]</a>    <span class="k">def</span> <span class="nf">daysinmonth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of days in current month</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
            <span class="c1"># return 30</span>
            <span class="k">return</span> <span class="n">_dayspermonth_360</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_leap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
                        <span class="n">has_year_zero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_dayspermonth_leap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_dayspermonth</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="datetime.format"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standard date representation</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span></div>

<div class="viewcode-block" id="datetime.fromordinal"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.fromordinal">[docs]</a>    <span class="k">def</span> <span class="nf">fromordinal</span><span class="p">(</span><span class="n">jday</span><span class="p">,</span> <span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;decimal&#39;</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span></div>

<div class="viewcode-block" id="datetime.isoformat"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.isoformat">[docs]</a>    <span class="k">def</span> <span class="nf">isoformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">timespec</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ISO date representation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">form0</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:05d}</span><span class="s1">-</span><span class="si">{:02d}</span><span class="s1">-</span><span class="si">{:02d}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form0</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">-</span><span class="si">{:02d}</span><span class="s1">-</span><span class="si">{:02d}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">timespec</span> <span class="o">==</span> <span class="s1">&#39;days&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form0</span>
            <span class="k">return</span> <span class="n">form</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">timespec</span> <span class="o">==</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:s}{:02d}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">form</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">timespec</span> <span class="o">==</span> <span class="s1">&#39;minutes&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:s}{:02d}</span><span class="s1">:</span><span class="si">{:02d}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">form</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">timespec</span> <span class="o">==</span> <span class="s1">&#39;seconds&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:s}{:02d}</span><span class="s1">:</span><span class="si">{:02d}</span><span class="s1">:</span><span class="si">{:02d}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">form</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">timespec</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;microseconds&#39;</span><span class="p">,</span> <span class="s1">&#39;milliseconds&#39;</span><span class="p">]:</span>
            <span class="n">second</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:02d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">timespec</span> <span class="o">==</span> <span class="s1">&#39;milliseconds&#39;</span><span class="p">:</span>
                <span class="n">millisecs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">second</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">millisecs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">timespec</span> <span class="o">==</span> <span class="s1">&#39;microseconds&#39;</span><span class="p">:</span>
                <span class="n">second</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">{:06d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">second</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">{:06d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{:s}{:02d}</span><span class="s1">:</span><span class="si">{:02d}</span><span class="s1">:</span><span class="si">{:s}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">form</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;illegal timespec&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="datetime.replace"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return datetime with new specified fields</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                <span class="s2">&quot;minute&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                <span class="s2">&quot;second&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;microsecond&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span>
                <span class="s2">&quot;has_year_zero&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">,</span>
                <span class="s2">&quot;calendar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">}</span>

        <span class="k">if</span> <span class="s1">&#39;dayofyr&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s1">&#39;dayofwk&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Replacing the dayofyr or dayofwk of a datetime&#39;</span>
                             <span class="s1">&#39; is not supported.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;calendar&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Replacing the calendar of a datetime is &#39;</span>
                             <span class="s1">&#39;not supported.&#39;</span><span class="p">)</span>

        <span class="c1"># if attempting to set year to zero, also set has_year_zero=True</span>
        <span class="c1"># (issue #248)</span>
        <span class="k">if</span> <span class="s1">&#39;year&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;has_year_zero&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;has_year_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">args</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="datetime.round_microseconds"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.round_microseconds">[docs]</a>    <span class="k">def</span> <span class="nf">round_microseconds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mathematically round microseconds to nearest second.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">iadd</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="mf">1000000.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iadd</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">odt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">odt</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">odt</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">odt</span></div>

<div class="viewcode-block" id="datetime.strftime"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.strftime">[docs]</a>    <span class="k">def</span> <span class="nf">strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing the date, controlled by an explicit format</span>
<span class="sd">        string</span>

<span class="sd">        For a complete list of formatting directives, see section &#39;strftime()</span>
<span class="sd">        and strptime() Behavior&#39; in the base Python documentation.</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_strftime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span></div>

<div class="viewcode-block" id="datetime.timetuple"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.timetuple">[docs]</a>    <span class="k">def</span> <span class="nf">timetuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a time.struct_time such as returned by time.localtime()</span>

<span class="sd">        The DST flag is -1. d.timetuple() is equivalent to</span>
<span class="sd">        time.struct_time((d.year, d.month, d.day, d.hour, d.minute,</span>
<span class="sd">        d.second, d.weekday(), yday, dst)), where yday is the</span>
<span class="sd">        day number within the current year starting with 1 for January 1st.</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ptime</span><span class="o">.</span><span class="n">struct_time</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dayofwk</span><span class="p">(),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">dayofyr</span><span class="p">(),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="datetime.toordinal"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.toordinal">[docs]</a>    <span class="k">def</span> <span class="nf">toordinal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fractional</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Julian day (integer) ordinal</span>

<span class="sd">        Day 0 starts at noon January 1 of the year -4713 for the</span>
<span class="sd">        Excel calendars.</span>

<span class="sd">        Day 0 starts at noon on January 1 of the year zero for</span>
<span class="sd">        the decimal calendars.</span>

<span class="sd">        If fractional=True, fractional part of day is included (default</span>
<span class="sd">        False).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ijd</span> <span class="o">=</span> <span class="n">_int_julian_day_from_date</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
            <span class="n">has_year_zero</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fractional</span><span class="p">:</span>
            <span class="c1"># At this point ijd is an integer representing noon UTC on the</span>
            <span class="c1"># given year, month, day.</span>
            <span class="c1"># Compute fractional day from hour, minute, second, microsecond</span>
            <span class="n">fracday</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">24.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1440.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span> <span class="o">+</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">second</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">1.e6</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)))</span> <span class="o">/</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">86400.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">longdouble</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">return</span> <span class="n">ijd</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">fracday</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ijd</span></div>

<div class="viewcode-block" id="datetime.to_tuple"><a class="viewcode-back" href="../../class_datetime.html#pyjams.class_datetime.datetime.to_tuple">[docs]</a>    <span class="k">def</span> <span class="nf">to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a datetime instance into a tuple of integers. Elements go</span>
<span class="sd">        in the order of decreasing significance, making it easy to compare</span>
<span class="sd">        datetime instances. Parts of the state that don&#39;t affect ordering</span>
<span class="sd">        are omitted.</span>
<span class="sd">        to_tuple(dt) is identical to (dt.year, dt.month, dt.day,</span>
<span class="sd">        dt.hour, dt.minute, dt.second, dt.microsecond).</span>
<span class="sd">        Compare to timetuple().</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_timedelta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return args and kwargs needed to create class instance</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                  <span class="s1">&#39;minute&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                  <span class="s1">&#39;second&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                  <span class="s1">&#39;microsecond&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span>
                  <span class="s1">&#39;dayofwk&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dayofwk</span><span class="p">,</span>
                  <span class="s1">&#39;dayofyr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dayofyr</span><span class="p">,</span>
                  <span class="s1">&#39;calendar&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
                  <span class="s1">&#39;has_year_zero&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_to_real_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extended Python datetime class</span>

<span class="sd">        Extra attributes are  dayofwk, dayofyr, and daysinmonth.</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add timedelta to datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">calendar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span>
            <span class="n">has_year_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">other</span>
            <span class="n">calendar</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">calendar</span>
            <span class="n">has_year_zero</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">has_year_zero</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">calendar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span>
        <span class="n">has_year_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">if</span> <span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
            <span class="n">cfdt</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;360_day&#39;</span><span class="p">,</span>
                               <span class="n">has_year_zero</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span>
            <span class="n">cfdt</span> <span class="o">=</span> <span class="n">cfdt</span> <span class="o">+</span> <span class="n">delta</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">cfdt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                <span class="n">cfdt</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_add_timedelta</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">delta</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                        <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="p">,</span>
                        <span class="n">calendar</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span> <span class="n">has_year_zero</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare two datetime instances</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">cf</span><span class="o">.</span><span class="n">datetime</span><span class="p">)):</span>
            <span class="n">dt_other</span> <span class="o">=</span> <span class="n">other</span>
            <span class="c1"># comparing two datetime instances</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="n">dt_other</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span> <span class="o">==</span> <span class="n">dt_other</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span> <span class="p">):</span>
                <span class="k">return</span> <span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">==</span> <span class="n">to_tuple</span><span class="p">(</span><span class="n">dt_other</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ord1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
                    <span class="n">ord1</span> <span class="o">=</span> <span class="mi">1721425</span>
                <span class="n">ord2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">dt_other</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                    <span class="n">ord2</span> <span class="o">=</span> <span class="mi">1721425</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span><span class="n">fractional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">ord1</span> <span class="o">==</span>
                        <span class="n">dt_other</span><span class="o">.</span><span class="n">toordinal</span><span class="p">(</span><span class="n">fractional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="n">ord2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__format__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string representing the date, controlled by an explicit format</span>
<span class="sd">        string</span>

<span class="sd">        For a complete list of formatting directives, see section &#39;strftime()</span>
<span class="sd">        and strptime() Behavior&#39; in the base Python documentation.</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the string format &quot;{t_obj}&quot;.format(t_obj=t_obj)</span>
        <span class="c1"># without an explicit format gives an empty string (format=&#39;&#39;)</span>
        <span class="c1"># so set this to None to get the default strftime behaviour</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">format</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_real_datetime</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Special method that allows instance to be pickled</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getstate</span><span class="p">()</span>
        <span class="n">date_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">_create_datetime</span><span class="p">,</span> <span class="p">(</span><span class="n">date_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String representation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">(</span><span class="si">{2}</span><span class="s2">, </span><span class="si">{3}</span><span class="s2">, </span><span class="si">{4}</span><span class="s2">, </span><span class="si">{5}</span><span class="s2">, </span><span class="si">{6}</span><span class="s2">, </span><span class="si">{7}</span><span class="s2">, </span><span class="si">{8}</span><span class="s2">,&quot;</span>
                <span class="s2">&quot; calendar=</span><span class="si">{9}</span><span class="s2">, has_year_zero=</span><span class="si">{10}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;pyjams&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ISO date representation</span>

<span class="sd">        Identical to cftime.datetime</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Substract timedelta or datetime from the datetime instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>  <span class="c1"># left arg is a datetime instance</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="c1"># datetime - datetime</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">calendar</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">calendar</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot compute the time difference&quot;</span>
                                    <span class="s2">&quot; between dates with different calendars&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot compute the time difference&quot;</span>
                                    <span class="s2">&quot; between dates that are not&quot;</span>
                                    <span class="s2">&quot; calendar-aware&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot compute the time difference&quot;</span>
                                    <span class="s2">&quot; between dates with different year zero&quot;</span>
                                    <span class="s2">&quot; conventions&quot;</span><span class="p">)</span>
                <span class="n">ord1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
                    <span class="n">ord1</span> <span class="o">=</span> <span class="mi">1721425</span>
                <span class="n">ord2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span><span class="p">:</span>
                    <span class="n">ord2</span> <span class="o">=</span> <span class="mi">1721425</span>
                <span class="n">ordinal_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">+</span> <span class="n">ord1</span>  <span class="c1"># julian day</span>
                <span class="n">ordinal_other</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span> <span class="o">+</span> <span class="n">ord2</span>
                <span class="n">days</span> <span class="o">=</span> <span class="n">ordinal_self</span> <span class="o">-</span> <span class="n">ordinal_other</span>
                <span class="n">seconds_self</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">+</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
                <span class="n">seconds_other</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">second</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">minute</span> <span class="o">+</span>
                                 <span class="mi">3600</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
                <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds_self</span> <span class="o">-</span> <span class="n">seconds_other</span>
                <span class="n">microseconds</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">microsecond</span>
                <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">microseconds</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">datetime_python</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">)):</span>
                <span class="c1"># datetime - real_datetime</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime_compatible</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot compute the time difference between dates&quot;</span>
                           <span class="s2">&quot; with different calendars. One of the datetime&quot;</span>
                           <span class="s2">&quot; objects may have been converted to a native&quot;</span>
                           <span class="s2">&quot; python datetime instance. Try using&quot;</span>
                           <span class="s2">&quot; only_use_cftime_datetimes=True when creating the&quot;</span>
                           <span class="s2">&quot; datetime object.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">_to_real_datetime</span><span class="p">()</span> <span class="o">-</span> <span class="n">other</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
                <span class="c1"># datetime - timedelta</span>
                <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">calendar</span> <span class="o">==</span> <span class="s1">&#39;decimal360&#39;</span><span class="p">:</span>
                    <span class="n">cfdt</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="o">*</span><span class="n">to_tuple</span><span class="p">(</span><span class="n">dt</span><span class="p">),</span> <span class="n">calendar</span><span class="o">=</span><span class="s1">&#39;360_day&#39;</span><span class="p">,</span>
                                       <span class="n">has_year_zero</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span>
                    <span class="n">cfdt</span> <span class="o">=</span> <span class="n">cfdt</span> <span class="o">-</span> <span class="n">other</span>
                    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">cfdt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                        <span class="n">cfdt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">cfdt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">_add_timedelta</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="o">-</span><span class="n">other</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span>
                                <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="p">,</span>
                                <span class="n">calendar</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span>
                                <span class="n">has_year_zero</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">has_year_zero</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime_python</span><span class="p">)</span> <span class="ow">or</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cf</span><span class="o">.</span><span class="n">real_datetime</span><span class="p">)):</span>
                <span class="c1"># real_datetime - datetime</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="n">datetime_compatible</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Cannot compute the time difference between dates&quot;</span>
                           <span class="s2">&quot; with different calendars. One of the datetime&quot;</span>
                           <span class="s2">&quot; objects may have been converted to a native&quot;</span>
                           <span class="s2">&quot; python datetime instance. Try using&quot;</span>
                           <span class="s2">&quot; only_use_cftime_datetimes=True when creating the&quot;</span>
                           <span class="s2">&quot; datetime object.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">_to_real_datetime</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">NotImplemented</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../contents.html">pyjams</a></h1>



<p class="blurb">A general Python package with a wide variety of miscellaneous utility functions.</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://github.com/mcuntz/pyjams">pyjams @ GitHub</a></li>
    
    <li class="toctree-l1"><a href="https://doi.org/10.5281/zenodo.5574388">pyjams @ Zenodo</a></li>
    
    <li class="toctree-l1"><a href="https://pypi.org/project/pyjams">pyjams @ PyPI</a></li>
    
    <li class="toctree-l1"><a href="https://anaconda.org/conda-forge/pyjams">pyjams @ conda-forge</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../contents.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2012-2023, Matthias Cuntz, Juliane Mai, Stephan Thober, Arndt Piayda.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>